<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Maria Gabriella - Seguro v2</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary-pink: #ff69b4; --dark-pink: #c71585; --success-green: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #fcf8fa; margin: 0; padding: 20px; }
        #loginContainer { max-width: 400px; margin: 100px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--primary-pink); text-align: center; display: block; }
        .input-login { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ffc0cb; border-radius: 8px; box-sizing: border-box; }
        .container { max-width: 1000px; margin: auto; display: none; }
        header { text-align: center; margin-bottom: 25px; }
        header h1 { color: var(--dark-pink); border-bottom: 2px solid var(--primary-pink); display: inline-block; padding-bottom: 5px; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav button { flex: 1; padding: 15px; border: 2px solid var(--primary-pink); border-radius: 10px; cursor: pointer; font-weight: bold; background: white; color: var(--dark-pink); }
        .nav button.active { background: var(--primary-pink); color: white; }
        .aba { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: none; border-top: 5px solid var(--primary-pink); }
        .aba.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ffc0cb; border-radius: 8px; box-sizing: border-box; }
        .btn-acao { background: var(--dark-pink); color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .btn-pdf { background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        .dash-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .card { padding: 20px; border-radius: 15px; color: white; text-align: center; font-weight: bold; }
        .card.pink { background-color: #ff85a2; }
        .card.dark-pink { background-color: #ff5c8a; }
        .card.green { background-color: var(--success-green); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #3d6e60; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .btn-del { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        #loading { position: fixed; top: 10px; right: 10px; background: #333; color: white; padding: 5px 10px; border-radius: 5px; display: none; z-index: 999; }
        .taxa-info { background: #fff3e0; color: #e65100; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; border: 1px solid #ffe0b2; }
    </style>
</head>
<body>

<div id="loading">Sincronizando...</div>

<div id="loginContainer">
    <h2>Acesso Restrito</h2>
    <p>Maria Gabriella Rezende Bento</p>
    <input type="email" id="emailLogin" class="input-login" placeholder="Seu e-mail">
    <input type="password" id="senhaLogin" class="input-login" placeholder="Sua senha">
    <button class="btn-acao" onclick="fazerLogin()">Entrar no Sistema</button>
</div>

<div class="container" id="mainApp">
    <header>
        <h1>Maria Gabriella Rezende Bento</h1>
        <br>
        <button onclick="fazerLogout()" style="background:none; border:none; color:gray; text-decoration:underline; cursor:pointer; font-size:12px;">Sair / Trocar Conta</button>
    </header>

    <div class="nav">
        <button id="btnTabDiario" class="active" onclick="mudarAba('diario')">Lan√ßamentos</button>
        <button id="btnTabHist" onclick="mudarAba('hist')">Hist√≥rico Clientes</button>
        <button id="btnTabMensal" onclick="mudarAba('mensal')">Relat√≥rio Mensal</button>
    </div>

    <div id="abaDiario" class="aba active">
        <div id="infoTaxaDia" class="taxa-info"></div>
        <div class="grid">
            <div><label>Data:</label><input type="date" id="dataInput" onchange="atualizarView()"></div>
            <div>
                <label>Cliente:</label>
                <input type="text" id="cliente" list="listaClientes" placeholder="Digite o nome...">
                <datalist id="listaClientes"></datalist>
            </div>
            <div><label>Servi√ßo:</label>
                <select id="procedimento">
                    <option value="Manicure Simples">Manicure Simples</option>
                    <option value="Alongamento de unhas">Alongamento de unhas</option>
                    <option value="Blindagem">Blindagem</option>
                    <option value="C√≠lios">C√≠lios</option>
                    <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                </select>
            </div>
            <div><label>Valor Bruto R$:</label><input type="number" id="valorInput" placeholder="0.00"></div>
        </div>
        <button class="btn-acao" onclick="adicionar()">Gravar Atendimento</button>
        <div class="dash-cards" style="margin-top: 30px;">
            <div class="card pink"><h4>Atendimentos</h4><p id="dTotalAtend">0</p></div>
            <div class="card dark-pink"><h4>Repasse Total</h4><p id="dTotalRepasse">R$ 0,00</p></div>
            <div class="card green"><h4>Seu Lucro</h4><p id="dTotalLiquido">R$ 0,00</p></div>
        </div>
        <table>
            <thead><tr><th>Cliente</th><th>Servi√ßo</th><th>Bruto</th><th>Repasse</th><th>L√≠quido</th><th>A√ß√£o</th></tr></thead>
            <tbody id="corpoDiario"></tbody>
        </table>
        <button class="btn-pdf" onclick="gerarPDF('dia')">üìÑ PDF do Dia</button>
    </div>

    <div id="abaHist" class="aba">
        <h3>Pesquisar Hist√≥rico</h3>
        <input type="text" id="buscaCliente" list="listaClientes" placeholder="Escolha a cliente..." onchange="verHistorico()">
        <div class="dash-cards" style="margin-top: 20px;">
            <div class="card pink"><h4>Visitas</h4><p id="hVisitas">0</p></div>
            <div class="card green"><h4>Total Bruto</h4><p id="hTotal">R$ 0,00</p></div>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Procedimento</th><th>Bruto</th></tr></thead>
            <tbody id="corpoHist"></tbody>
        </table>
    </div>

    <div id="abaMensal" class="aba">
        <input type="month" id="mesFiltro" onchange="atualizarView()" style="max-width:200px; margin-bottom:20px;">
        <div class="dash-cards">
            <div class="card pink"><h4>Atendimentos</h4><p id="mTotalAtend">0</p></div>
            <div class="card dark-pink"><h4>Repasse</h4><p id="mTotalRepasse">R$ 0,00</p></div>
            <div class="card green"><h4>Lucro</h4><p id="mTotalLiquido">R$ 0,00</p></div>
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Servi√ßo</th><th>Bruto</th><th>L√≠quido</th></tr></thead>
            <tbody id="corpoMensal"></tbody>
        </table>
        <button class="btn-pdf" onclick="gerarPDF('mes')">üìÑ PDF Mensal</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDdvWWvUdbOjPcQxQcb5jn1rXffHm5IThM",
        authDomain: "gestaogabriella-b6b5f.firebaseapp.com",
        projectId: "gestaogabriella-b6b5f",
        storageBucket: "gestaogabriella-b6b5f.firebasestorage.app",
        messagingSenderId: "751665904056",
        appId: "1:751665904056:web:8ff310e8b38effa6b4374d",
        measurementId: "G-W9L8T22VPF"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let atendimentos = [];

    function fazerLogin() {
        const email = document.getElementById('emailLogin').value;
        const senha = document.getElementById('senhaLogin').value;
        if(!email || !senha) return alert("Preencha!");
        auth.signInWithEmailAndPassword(email, senha).catch(e => alert("Erro: " + e.message));
    }

    function fazerLogout() { auth.signOut(); }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            iniciarEscutaDados(user.uid);
        } else {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }
    });

    function iniciarEscutaDados(userId) {
        document.getElementById('loading').style.display = 'block';
        db.collection("atendimentos")
          .where("owner", "==", userId)
          .orderBy("data", "desc")
          .onSnapshot((snapshot) => {
            atendimentos = [];
            snapshot.forEach((doc) => atendimentos.push({ id: doc.id, ...doc.data() }));
            atualizarSugestoes();
            atualizarView();
            document.getElementById('loading').style.display = 'none';
        }, (error) => {
            console.error(error);
            document.getElementById('loading').style.display = 'none';
        });
    }

    async function adicionar() {
        const user = auth.currentUser;
        const data = document.getElementById('dataInput').value;
        const cliente = document.getElementById('cliente').value;
        const proc = document.getElementById('procedimento').value;
        const bruto = parseFloat(document.getElementById('valorInput').value);
        if(!cliente || isNaN(bruto)) return alert("Erro!");
        const taxa = (new Date(data + 'T00:00:00').getDay() === 0) ? 0.20 : 0.30;
        const rep = (bruto - 3) * taxa;
        try {
            await db.collection("atendimentos").add({
                data, cliente, procedimento: proc, bruto, repasse: rep, liquido: bruto - rep, owner: user.uid
            });
            document.getElementById('cliente').value = "";
            document.getElementById('valorInput').value = "";
        } catch (e) { alert(e); }
    }

    function mudarAba(tipo) {
        document.querySelectorAll('.aba').forEach(a => a.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('aba' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).classList.add('active');
        document.getElementById('btnTab' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).classList.add('active');
    }

    function atualizarView() {
        const dataF = document.getElementById('dataInput').value;
        const mesF = document.getElementById('mesFiltro').value;
        if(dataF) {
            const dObj = new Date(dataF + 'T00:00:00');
            document.getElementById('infoTaxaDia').innerText = `Taxa Hoje: ${(dObj.getDay() === 0) ? "20% (Domingo)" : "30%"}`;
        }
        const dia = atendimentos.filter(i => i.data === dataF);
        const mes = atendimentos.filter(i => i.data.startsWith(mesF));
        render('corpoDiario', dia, true);
        render('corpoMensal', mes, false);
        calc('dTotalAtend', 'dTotalRepasse', 'dTotalLiquido', dia);
        calc('mTotalAtend', 'mTotalRepasse', 'mTotalLiquido', mes);
    }

    function render(id, lista, acao) {
        const corpo = document.getElementById(id);
        corpo.innerHTML = "";
        lista.forEach(i => {
            corpo.innerHTML += `<tr>
                ${acao ? '' : `<td>${i.data.split('-').reverse().join('/')}</td>`}
                <td>${i.cliente}</td><td>${i.procedimento}</td>
                <td>R$ ${i.bruto.toFixed(2)}</td><td>R$ ${i.repasse.toFixed(2)}</td><td>R$ ${i.liquido.toFixed(2)}</td>
                ${acao ? `<td><button class="btn-del" onclick="apagar('${i.id}')">X</button></td>` : ''}
            </tr>`;
        });
    }

    function calc(at, re, li, lista) {
        document.getElementById(at).innerText = lista.length;
        document.getElementById(re).innerText = `R$ ${lista.reduce((a,b)=>a+b.repasse,0).toFixed(2)}`;
        document.getElementById(li).innerText = `R$ ${lista.reduce((a,b)=>a+b.liquido,0).toFixed(2)}`;
    }

    async function apagar(id) { if(confirm("Apagar?")) await db.collection("atendimentos").doc(id).delete(); }

    function atualizarSugestoes() {
        const nomes = [...new Set(atendimentos.map(i => i.cliente))];
        const datalist = document.getElementById('listaClientes');
        datalist.innerHTML = "";
        nomes.forEach(n => {
            const option = document.createElement('option');
            option.value = n;
            datalist.appendChild(option);
        });
    }

    function verHistorico() {
        const nome = document.getElementById('buscaCliente').value;
        const hist = atendimentos.filter(i => i.cliente === nome).sort((a,b)=>b.data.localeCompare(a.data));
        const corpo = document.getElementById('corpoHist');
        corpo.innerHTML = "";
        let total = 0;
        hist.forEach(i => {
            total += i.bruto;
            corpo.innerHTML += `<tr><td>${i.data.split('-').reverse().join('/')}</td><td>${i.procedimento}</td><td>R$ ${i.bruto.toFixed(2)}</td></tr>`;
        });
        document.getElementById('hVisitas').innerText = hist.length;
        document.getElementById('hTotal').innerText = `R$ ${total.toFixed(2)}`;
    }

    function gerarPDF(modo) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const f = modo === 'dia' ? document.getElementById('dataInput').value : document.getElementById('mesFiltro').value;
        const lista = atendimentos.filter(i => (modo === 'dia' ? i.data === f : i.data.startsWith(f)));
        if(lista.length === 0) return alert("Sem dados.");
        const dados = lista.map(i => [i.data.split('-').reverse().join('/'), i.cliente, i.procedimento, `R$ ${i.bruto.toFixed(2)}`, `R$ ${i.liquido.toFixed(2)}`]);
        doc.text("Maria Gabriella Rezende Bento", 14, 15);
        doc.autoTable({ head: [['Data','Cliente','Servi√ßo','Bruto','L√≠quido']], body: dados, startY: 20, headStyles: {fillColor: [61, 110, 96]} });
        doc.save(`Relatorio_${f}.pdf`);
    }
</script>
</body>
</html>